#!/usr/bin/env node
var fs      = require('fs');
var program = require('commander');
var Q       = require('q');

var pkg       = require('../package.json');
var OdtConverter = require('../lib');


program
    .version(pkg.version)
    .usage('[options] <input> <output>')
    .option('-i, --images <folder>', 'Export folder for images')
    .option('-b, --beautify', 'Pretty-print output HTML')
    .option('-t, --trim', 'Remove empty paragraphs from output')
    .parse(process.argv);

// Read filename from command-line
var filepath = program.args[0];
if (!filepath) {
    fail('Path to file is missing.');
}

// Read output name
var outputFile = program.args[1];

// Check that file exists
Q.nfcall(fs.stat, filepath)
.then(function() {
    // Construct converter options
    var opts = {
        path:      filepath,
        imgFolder: program.images,
        beautify:  program.beautify,
        trim:      program.trim
    };

    return opts;
},
function(err) {
    var e = (err.code == 'ENOENT')? 'File '+filepath+' doesn\'t exist.' : err;
    fail(e);
})
// Launch conversion
.then(function(opts) {
    return OdtConverter.toHTML(opts);
})
// Process output
.then(function(html) {
    if (!outputFile) {
        console.log(html);
        return;
    }

    return Q.nfcall(fs.writeFile, outputFile, html);
}, fail)
.then(function() {
    console.log('Done :)');
}, fail);

function fail(err) {
    console.log('Error:');
    console.log(err);
    process.exit(1);
}